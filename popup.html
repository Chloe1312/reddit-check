<!doctype html>
<html>
<!-- 
 Copyright (C) 2010  Hrishikesh Bakshi
 For permissions, check LICENSE file in this folder.
-->
<head>
<style>
body {
  min-width:400px;
  overflow-x:hidden;
}

li {
    list-style-type:none;
    padding: 5px 0px 5px 0px;
    width: 400px;
}

#data {
    width: 430px;
}

.age {
    font-size: 9px;
    color: #909090;
    height: 12px;
    padding-left: 10px;
}

.score {
    height:14px;
    /*width: 45px;*/
    padding: 0px 7px 0px 0px;
    text-align: center;
    display: block;
    float: left;
    color: #FF8B60;
}
</style>
<script src="jquery.min.js" language="javascript">
</script>
<script>

//var tabId = chrome.extension.getBackgroundPage().selectedTabId;
var     url = chrome.extension.getBackgroundPage().selectedURL;
var   title = chrome.extension.getBackgroundPage().selectedTitle;

url = encodeURIComponent(url);
var submitUrl = "http://www.reddit.com/submit?url=" + url;
var resubmitUrl = "http://www.reddit.com/submit?resubmit=true&url=" + url;
var submitCount = 0;
var info;
var permalinks = [];
var date_now = new Date().getTime(); 
var date_entry; 
var one_day = 86400000; // milliseconds

// get URL info
function getURLInfo(url)
{
    var redditUrl = "http://www.reddit.com/api/info.json?url=" +url;
    $.getJSON(
        redditUrl,
        parseURLData
    );
}

// parse json data
function parseURLData(jsonData)
{
    submitCount=0;
    $("div#timeout").hide(0);
    var data = [ 0, "", "", "", "", "", "", "", "", url];

    for( var i=0; entry = jsonData.data.children[i]; i++) {
            submitCount +=1;
            date_entry = new Date(entry.data.created_utc*1000).getTime();
            permalinks[i] = {
                link: entry.data.permalink,
                title: entry.data.title,
                score: entry.data.score+"",
                age: Math.ceil((date_now-date_entry)/one_day),
                comments: entry.data.num_comments+"",
                subreddit: entry.data.subreddit,
            };
    }
    
    $("#data").append("<h4>"+title+"</h4>");
    if(submitCount) {
        $("#data").append("<p style='color:red;'>Submitted "+
            submitCount + " times.</p><p><a title='Post to reddit'"+
            " target='_blank' href='" + resubmitUrl + 
            "'>Submit this anyway.</a></p>");
    }
    else {
        $("#data").append("<p style='color:green;'>Not Submitted Yet!</p><p>"+
            "<a target='_blank' title='Post to reddit' href='"+submitUrl+
            "'>Reddit this!</a></p>");
    }
    showLinks();
}

function showLinks() {
    if(submitCount)
        $("#links").append("<h4> Submissions</h4>");
    $.each(
        permalinks,
        function(index, permalink) {
            $("#links").append(
                "<li>"+ 
                "<div class='score'>"+permalink.score+"</div>"+
                " <a href='http:\\\\www.reddit.com" +
                permalink.link + "' title='"+
                permalink.link + "' target='_blank' >"+
                permalink.title + "</a>"+
                "<span class='age'>"+permalink.age+ " days ago "+
                permalink.comments+" comments r/"+permalink.subreddit+
                "</span>"+
                "</li>"
            );
        }
    );
}
//url="http://news.ycombinator.com";

</script>
</head>
<body>
    <div id="data">
    </div>
    <div id="links">
    </div>
    <div id="timeout">
        Loading... please wait.
    </div>
    <script type="text/javascript">
    getURLInfo(url);
    </script>
</body>
</html>
